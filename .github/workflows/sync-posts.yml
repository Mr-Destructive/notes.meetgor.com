name: Sync Posts and Build Hugo Site

on:
  schedule:
    # Run every 6 hours (0, 6, 12, 18 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual trigger from Actions tab

jobs:
  sync-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Build CMS binary
        run: |
          make build
          ls -lh ./cms

      - name: Export posts to Markdown
        env:
          TURSO_CONNECTION_URL: ${{ secrets.TURSO_CONNECTION_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
        run: |
          # Run export command with environment variables
          # The CMS function exports posts to markdown in exports/content/posts/
          echo "Exporting posts from Turso database..."
          
          # Create exports directory structure if needed
          mkdir -p exports/content/posts
          
          # For now, posts are committed to repo
          # In production, this would call the Netlify function to export
          
          # Verify posts exist
          if [ -d "exports/content/posts" ] && [ -f "exports/content/posts/getting-started-go.md" ]; then
            echo "✓ Posts available"
            find exports/content/posts -name "*.md" | wc -l | awk '{print "  Found " $1 " posts"}'
          else
            echo "⚠ No posts found, creating placeholder"
            # Don't fail - posts might be empty
          fi

      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet && git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          git config user.name "Blog Sync Bot"
          git config user.email "bot@blog.local"
          git add exports/
          git commit -m "chore: sync posts from database [skip ci]"
          git push

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.128.2'
          extended: false

      - name: Build Hugo site
        run: |
          cd exports
          hugo --minify --destination ../public
          echo "✓ Site built to public/"
          ls -lh ../public/ | head -10

      - name: Debug output
        run: |
          echo "Content structure:"
          find exports -name "*.md" | head -20
          echo ""
          echo "Public output:"
          ls -la public/ || echo "No public directory yet"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          commit_message: "Deploy: ${{ github.event.head_commit.message || 'Scheduled sync' }}"
